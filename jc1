local TradeApp = require(game:GetService("ReplicatedStorage").ClientModules.Core.UIManager.Apps.TradeApp)
local TradeHistoryApp = require(game:GetService("ReplicatedStorage").ClientModules.Core.UIManager.Apps.TradeHistoryApp)
local PlayerProfileApp = require(game.ReplicatedStorage.ClientModules.Core.UIManager.Apps.PlayerProfileApp.PlayerProfileApp)
local profile_func = PlayerProfileApp.open_player_profile_for_user_id
local create_trade_frame = TradeHistoryApp._create_trade_frame
local v_u_1 = require(game.ReplicatedStorage:WaitForChild("Fsys")).load
local v_u_3 = v_u_1("RouterClient")
local_offer = nil
local saved_ids = {}
local custom_name = "NO_CUSTOM_NAME"
local parter_offer
local func
local old1
local old2
local old3
local old4
local old5
local old6
local old7
local old8
local old9
local wtf = " "
getgenv().customnames = false
local petstbl = {
"Bat Dragon",
"Phantom Dragon",
"Kitty Bat",
"Frost Dragon",
"Shadow Dragon",
"Giraffe",
"Owl",
"Parrot",
"Crow",
"Evil Unicorn",
"Arctic Reindeer",
"Diamond Butterfly",
"Hedgehog",
"Balloon Unicorn",
"Blazing Lion",
"Dalmatian",
"Orchid Butterfly",
"Turtle",
"Pelican",
"Monkey King",
"Albino Monkey",
"Haetae",
"Frostbite Bear",
"Strawberry Shortcake Bat Dragon",
"Hot Doggo",
"Chocolate Chip Bat Dragon",
"Kangaroo",
"Cow",
"Pirate Ghost Capuchin Monkey",
"Flamingo",
"African Wild Dog",
"Peppermint Penguin",
"Lion",
"Crocodile",
"Elephant",
"Blue Dog",
"Caterpillar",
"Frost Fury",
"Lava Dragon",
"Golden Penguin",
"Candyfloss Chick",
"Nessie",
"Vampire Dragon",
"Winged Tiger",
"Sugar Glider",
"Mechapup",
"Fairy Bat Dragon",
"Undead Jousting Horse",
"Cupid Dragon",
"Golden Chow-Chow",
"Mini Pig",
"Irish Water Spaniel",
"Goat",
"Glacier Moth",
"Sheeeeep",
"Goose",
"Pig",
"Pink Cat",
"Jekyll Hydra",
"Papa Moose",
"Black-Chested Pheasant",
"Diamond Amazon",
"Royal Mistletroll",
"Frost Unicorn",
"Moose Calf",
"Emperor Gorilla",
"Mermicorn",
"Diamond Hummingbird",
"Shark Puppy",
"Giant Gold Scarab",
"Caelum Cervi",
"Bush Elephant",
"Sugar Axolotl",
"Sakura Spirit",
"Diamond Hamster",
"Field Mouse",
"Diamond Albatross",
"Glacier Kitsune",
"Albino Gorilla",
"Werewolf",
"Grim Dragon",
"Lavender Dragon",
"Unicorn",
"Tortuga de la Isla",
"Purple Butterfly",
"Many Mackerel",
"Goat",
"Jellyfish",
"Puffin",
"Arctic Fox",
"Bald Eagle",
"Lion Cub",
"Kookaburra",
"Groundhog",
"Alpaca",
"Zombie Buffalo",
"Happy Clam",
"Platypus",
"Sea Slug",
"Honey Badger",
"Slime",
"Hyena",
"Shrew",
"Giant Panda",
"Emberlight",
"Border Collie",
"Hare",
"Ring-tailed Lemur",
"Chicken",
"Meerkat"
}

-- New globals for fake partner offer manipulation
getgenv().fake_partner = false  -- Toggle to enable fake partner offer
getgenv().fake_partner_items = {}
getgenv().fake_partner_confirmed = false
getgenv().partner_petname = "Dog"
getgenv().partner_ride = false
getgenv().partner_fly = false
getgenv().partner_neon = false
getgenv().partner_meganeon = false

-- Function to get pet name from kind/id (reverse lookup for display)
local m = require(game:GetService("ReplicatedStorage").ClientDB.Inventory.InventoryDB)
local function getNameFromKind(kind)
    for _, v in pairs(m.pets) do
        if v["kind"] == kind then
            return v["name"]
        end
    end
    return "Unknown"
end

-- Function to get display options for partner items dropdown
local function getPartnerPetOptions()
    local options = {}
    for _, item in ipairs(getgenv().fake_partner_items) do
        local name = getNameFromKind(item.kind)
        table.insert(options, name .. " (" .. item.unique .. ")")
    end
    return options
end

for _,v in pairs(getgc(true)) do
    if typeof(v) == "table" and rawget(v,"trade") then
        for kk,vv in pairs(v['trade']) do
            if typeof(tonumber(kk)) == "number" then
                func = vv
            end
        end
    end
end
for _,v in pairs(getgc(true)) do
if typeof(v) == "table" and rawget(v,"_get_partner_offer") then
parter_offer = v._get_partner_offer
    end
end
old1 = hookfunction(TradeApp._change_local_trade_state,function(a,b)
for k,v in pairs(b) do
        print(k)
if k == "sender_offer" or k == "recipient_offer" then -- в конф нет айтемов
            for kk,vv in pairs(v) do
                if kk == "items" then
                    local_offer = v.items
                end
            end
else
end
end
return old1(a,b)
end)
old2 = hookfunction(TradeApp._overwrite_local_trade_state,function(a,b)
if a~=nil and b~= nil and local_offer ~= nil then
if game.Players.LocalPlayer == b.sender then
b.sender_offer.items = local_offer
else
b.recipient_offer.items = local_offer
end
end
    return old2(a,b)
end)
old3 = hookfunction(TradeApp._remove_item_from_my_offer,function(p174, p175)
    local function findKey(alltables,needtable)
        for k,v in pairs(alltables) do
            if v["unique"] == needtable["unique"] then
                return k
            end
        end
    end
    if p175.category == "houses" then
p174.UIManager.apps.HintApp:hint({
["text"] = "You can\'t remove this item.",
["length"] = 5,
["overridable"] = true
})
else
v_u_3.get("TradeAPI/RemoveItemFromOffer"):FireServer(p175.unique)
local v176, v177 = p174:_get_my_offer()
local v178 = findKey(v176.items,p175)
table.remove(v176.items, v178)
local v179 = {
[v177] = {
["items"] = v176.items
}
}
p174:_change_local_trade_state(v179)
p174:_lock_trade_for_appropriate_time()
p174:refresh_all()
end
end)
old4 = hookfunction(func,function(...)
local args = {...}
if #args > 2 then
for k,v in pairs(args) do
if typeof(v) == "table" then
                print(local_offer)
if local_offer ~= nil then
if game.Players.LocalPlayer == v.sender then
v["sender_offer"]["items"] = local_offer
else
v["recipient_offer"]["items"] = local_offer
end
end
end
end
end
return old4(unpack(args))
end)
old5 = hookfunction(TradeApp.hide,function(...)
    local v_u_1 = require(game.ReplicatedStorage:WaitForChild("Fsys")).load
    local v_u_10 = v_u_1("ClientData")
    if local_offer ~= nil then
        for k,v in pairs(v_u_10.get("inventory")["pets"]) do
            for kk,vv in pairs(local_offer) do
                if vv['unique'] == k then
                    v_u_10.get("inventory")["pets"][k] = nil
                end
            end
        end
    end
    local_offer = nil
    return old5(...)
end)
old6 = hookfunction(TradeApp.refresh_all,function(arg1)
    local ab = arg1:_get_my_offer()
local ab2 = arg1:_get_partner_offer()
    if ab.confirmed and ab2.confirmed then
        local main_tbl
        for _,a in pairs(getgc(true)) do
            if typeof(a) == "table" and rawget(a,"local_trade_state") then
                main_tbl = a
            end
        end
        if saved_ids[tostring(main_tbl.local_trade_state.trade_id)] == nil then
            saved_ids[tostring(main_tbl.local_trade_state.trade_id)] = {["items"] = local_offer,["name"] = (getgenv().customnames and custom_name) or ab2["player_name"] }
        end
end
    return old6(arg1)
end)
old7 = hookfunction(create_trade_frame,function(...)
    local args = {...}
    local arg2 = args[2]
    if saved_ids[tostring(arg2.trade_id)] then
        if arg2.sender_name == game.Players.LocalPlayer.Name then
            arg2.sender_items = saved_ids[tostring(arg2.trade_id)]["items"]
            arg2.recipient_name = saved_ids[tostring(arg2.trade_id)]["name"]
        else
            arg2.recipient_items = saved_ids[tostring(arg2.trade_id)]["items"]
            arg2.sender_name = saved_ids[tostring(arg2.trade_id)]["name"]
        end
    end
    print("hooked")
    return old7(...)
end)
old8 = hookfunction(parter_offer,function(...)
    local tbl,a= old8(...)
    if getgenv().fake_partner then
        tbl['items'] = getgenv().fake_partner_items
        tbl['confirmed'] = getgenv().fake_partner_confirmed
    end
    if getgenv().customnames then
        tbl['player_name'] = custom_name
    end
    return tbl,a
end)
old9 = hookfunction(profile_func,function(_,id)
    if getgenv().customnames then
        id = game.Players[custom_name].UserId
    end
    return old9(_,id)
end)
getgenv().petname = "Dog"
getgenv().ride = false
getgenv().fly = false
getgenv().neon = false
getgenv().meganeon = false
local function makePetPattern(id,kind,unique,neon,mega,fly,ride)
    return {
        ["unique"] = unique,
        ["category"] = "pets",
        ["id"] = id,
        ["kind"] = kind,
        ["properties"] = {
            ["pet_trick_level"] = 0,
            ["rideable"] = false,
            ['friendship_level'] = 0,
            ["age"] = math.random(1, 5),
            ["flyable"] = fly,
            ["rideable"] = ride,
            ["neon"] = neon,
            ["mega_neon"] = mega,
            ["ailments_completed"] = 0
        },
        ["newness_order"] = 0
    }
end
local function createPet(name,fly,ride,neon,meganeon)
    local m = require(game:GetService("ReplicatedStorage").ClientDB.Inventory.InventoryDB)
    for k,v in pairs(m.pets) do
        if v["name"]:lower() == name:lower() then
            local uniq = "2_"..tostring(math.random(1,20000000000000))
            local v_u_1 = require(game.ReplicatedStorage:WaitForChild("Fsys")).load
            local v_u_10 = v_u_1("ClientData")
            v_u_10.get("inventory")["pets"][uniq] = makePetPattern(v['id'],v['kind'],uniq,neon,meganeon,fly,ride)
        end
    end
end

-- New function for adding to partner offer (direct to items table, no inventory)
local function addToPartnerOffer(name, fly, ride, neon, meganeon)
    local m = require(game:GetService("ReplicatedStorage").ClientDB.Inventory.InventoryDB)
    for k, v in pairs(m.pets) do
        if v["name"]:lower() == name:lower() then
            local uniq = "fake_" .. tostring(math.random(1, 20000000000000))  -- Unique prefix for fake
            local pet = makePetPattern(v['id'], v['kind'], uniq, neon, meganeon, fly, ride)
            table.insert(getgenv().fake_partner_items, pet)
            -- Refresh trade UI if open
            if TradeApp and TradeApp.refresh_all then
                TradeApp:refresh_all()
            end
        end
    end
end

local event = Instance.new("BindableEvent")
event.Event:Connect(function(name,fly,ride,neon,meganeon)
    createPet(name,fly,ride,neon,meganeon)
end)
local function isPetExist(petname)
    local m = require(game:GetService("ReplicatedStorage").ClientDB.Inventory.InventoryDB)
    for k,v in pairs(m.pets) do
        if v["name"] == petname then
            return true
        end
    end
    return false
end
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "Adopt me",
    Icon = 0,
    LoadingTitle = "Rayfield Interface Suite",
    LoadingSubtitle = "",
    ShowText = "Rayfield",
    Theme = "Default",
    ToggleUIKeybind = "K",
    DisableRayfieldPrompts = false,
    DisableBuildWarnings = false,
    ConfigurationSaving = {
       Enabled = false,
       FolderName = "",
       FileName = "mines_file"
    },
    Discord = {
       Enabled = false,
       Invite = "noinvitelink",
       RememberJoins = true
    },
    KeySystem = false,
 })
local main_tab = Window:CreateTab("Main",0)
local Input = main_tab:CreateInput({
    Name = "Pet name",
    CurrentValue = "",
    PlaceholderText = "Pet name",
    RemoveTextAfterFocusLost = false,
    Flag = "Input1",
    Callback = function(Text)
        getgenv().petname = Text
    end,
 })
local ride_toggle = main_tab:CreateToggle({
    Name = "Ride",
    CurrentValue = false,
    Flag = "Toggle1",
    Callback = function(Value)
        getgenv().ride = Value
    end,
})
local fly_toggle = main_tab:CreateToggle({
    Name = "Fly",
    CurrentValue = false,
    Flag = "Toggle2",
    Callback = function(Value)
        getgenv().fly = Value
    end,
})
local neon_toggle = main_tab:CreateToggle({
    Name = "Neon",
    CurrentValue = false,
    Flag = "Toggle3",
    Callback = function(Value)
        getgenv().neon = Value
        print(getgenv().neon)
    end,
})
local meganeon_toggle = main_tab:CreateToggle({
    Name = "Mega neon",
    CurrentValue = false,
    Flag = "Toggle4",
    Callback = function(Value)
        getgenv().meganeon = Value
    end,
})
local Button = main_tab:CreateButton({
    Name = "Create pet",
    Callback = function()
        event:Fire(getgenv().petname,getgenv().fly,getgenv().ride,getgenv().neon,getgenv().meganeon)
    end,
 })
local Button2 = main_tab:CreateButton({
    Name = "Spawn pets",
    Callback = function()
        for _,namepet in pairs(petstbl) do
            for i = 1,math.random(5,20) do
                event:Fire(namepet,getgenv().fly,getgenv().ride,getgenv().neon,getgenv().meganeon)
            end
        end
    end,
 })
local names_toggle = main_tab:CreateToggle({
    Name = "Custom names",
    CurrentValue = false,
    Flag = "Toggle5",
    Callback = function(Value)
        getgenv().customnames = Value
    end,
})
local name_input = main_tab:CreateInput({
    Name = "Custom Name",
    CurrentValue = "",
    PlaceholderText = "Name",
    RemoveTextAfterFocusLost = false,
    Flag = "Input2",
    Callback = function(Text)
        custom_name = Text
    end,
 })
local function getPlayerNames()
    local tbll = {}
    for _,v in pairs(game:GetService("Players"):GetChildren()) do
        local name = wtf..v.Name
        table.insert(tbll, name)
    end
    return tbll
end
local Dropdown = main_tab:CreateDropdown({
    Name = "Players",
    Options = getPlayerNames(),
    CurrentOption = {},
    MultipleOptions = false,
    Flag = "Dropdown1",
    Callback = function(Options)
        local name = unpack(Options):gsub(wtf,"")
        getgenv().custom_name = name
        name_input:Set(name)
    end,
})

-- New section for fake partner controls
local partner_section = main_tab:CreateSection("Fake Partner Offer Controls")

local fake_partner_toggle = main_tab:CreateToggle({
    Name = "Enable Fake Partner Offer",
    CurrentValue = false,
    Flag = "Toggle6",
    Callback = function(Value)
        getgenv().fake_partner = Value
        if TradeApp and TradeApp.refresh_all then
            TradeApp:refresh_all()
        end
    end,
})

local partner_input = main_tab:CreateInput({
    Name = "Partner Pet name",
    CurrentValue = "",
    PlaceholderText = "Partner Pet name",
    RemoveTextAfterFocusLost = false,
    Flag = "Input3",
    Callback = function(Text)
        getgenv().partner_petname = Text
    end,
})

local partner_ride_toggle = main_tab:CreateToggle({
    Name = "Partner Ride",
    CurrentValue = false,
    Flag = "Toggle7",
    Callback = function(Value)
        getgenv().partner_ride = Value
    end,
})

local partner_fly_toggle = main_tab:CreateToggle({
    Name = "Partner Fly",
    CurrentValue = false,
    Flag = "Toggle8",
    Callback = function(Value)
        getgenv().partner_fly = Value
    end,
})

local partner_neon_toggle = main_tab:CreateToggle({
    Name = "Partner Neon",
    CurrentValue = false,
    Flag = "Toggle9",
    Callback = function(Value)
        getgenv().partner_neon = Value
    end,
})

local partner_meganeon_toggle = main_tab:CreateToggle({
    Name = "Partner Mega neon",
    CurrentValue = false,
    Flag = "Toggle10",
    Callback = function(Value)
        getgenv().partner_meganeon = Value
    end,
})

local add_partner_button = main_tab:CreateButton({
    Name = "Add to Partner Offer",
    Callback = function()
        addToPartnerOffer(getgenv().partner_petname, getgenv().partner_fly, getgenv().partner_ride, getgenv().partner_neon, getgenv().partner_meganeon)
        partner_dropdown:Refresh(getPartnerPetOptions())  -- Refresh dropdown
    end,
})

local partner_confirmed_toggle = main_tab:CreateToggle({
    Name = "Partner Confirmed (Agree)",
    CurrentValue = false,
    Flag = "Toggle11",
    Callback = function(Value)
        getgenv().fake_partner_confirmed = Value
        if TradeApp and TradeApp.refresh_all then
            TradeApp:refresh_all()
        end
    end,
})

local clear_partner_button = main_tab:CreateButton({
    Name = "Clear Partner Offer",
    Callback = function()
        getgenv().fake_partner_items = {}
        if TradeApp and TradeApp.refresh_all then
            TradeApp:refresh_all()
        end
        partner_dropdown:Refresh(getPartnerPetOptions())
    end,
})

local selected_partner_pet = nil
local partner_dropdown = main_tab:CreateDropdown({
    Name = "Partner Pets in Offer",
    Options = getPartnerPetOptions(),
    CurrentOption = {},
    MultipleOptions = false,
    Flag = "Dropdown2",
    Callback = function(Options)
        local option = unpack(Options)
        if option then
            -- Parse unique from "Name (unique)"
            local unique = option:match("%((.-)%)")
            selected_partner_pet = unique
        end
    end,
})

local remove_partner_button = main_tab:CreateButton({
    Name = "Remove Selected from Partner",
    Callback = function()
        if selected_partner_pet then
            for i, item in ipairs(getgenv().fake_partner_items) do
                if item.unique == selected_partner_pet then
                    table.remove(getgenv().fake_partner_items, i)
                    break
                end
            end
            if TradeApp and TradeApp.refresh_all then
                TradeApp:refresh_all()
            end
            partner_dropdown:Refresh(getPartnerPetOptions())
            selected_partner_pet = nil
        end
    end,
})

-- New button to open fake profile (to start trade manually from profile)
local open_fake_profile_button = main_tab:CreateButton({
    Name = "Open Fake Profile (for Trade Start)",
    Callback = function()
        -- Opens the profile of the custom user_id, from which you can request trade if nearby
        if custom_name and game.Players:FindFirstChild(custom_name) then
            profile_func(nil, game.Players.LocalPlayer.UserId)  -- Will hook to custom id
        else
            print("Custom name not set or player not found.")
        end
    end,
})

game:GetService("Players").PlayerAdded:Connect(function(plr)
    Dropdown:Refresh(getPlayerNames())
end)
game:GetService("Players").PlayerRemoving:Connect(function(plr)
    Dropdown:Refresh(getPlayerNames())
end)
