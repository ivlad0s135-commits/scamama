-- ПОЛНЫЙ РАБОЧИЙ СКРИПТ ДЛЯ ПОСТАНОВОЧНЫХ ВИДЕО (ДЕКАБРЬ 2025 - РАБОТАЕТ)
-- Всё что ты просила + ещё удобнее интерфейс

local TradeApp = require(game:GetService("ReplicatedStorage").ClientModules.Core.UIManager.Apps.TradeApp)
local TradeHistoryApp = require(game:GetService("ReplicatedStorage").ClientModules.Core.UIManager.Apps.TradeHistoryApp)
local PlayerProfileApp = require(game.ReplicatedStorage.ClientModules.Core.UIManager.Apps.PlayerProfileApp.PlayerProfileApp)
local profile_func = PlayerProfileApp.open_player_profile_for_user_id
local create_trade_frame = TradeHistoryApp._create_trade_frame

local Fsys = require(game.ReplicatedStorage:WaitForChild("Fsys")).load
local RouterClient = Fsys("RouterClient")
local ClientData = Fsys("ClientData")

local_offer = nil
local saved_ids = {}
local custom_name = "JeffBlox" -- дефолтный фейк-ник (можно менять в интерфейсе)
local partner_offer_func
local trade_func

local old = {}

getgenv().customnames = true -- всегда включено для постановки
getgenv().fake_trade_active = false
getgenv().current_tradeapp = nil
getgenv().fake_partner_items = {}
getgenv().fake_partner_confirmed = false
getgenv().fake_partner_name = "JeffBlox"

-- Поиск нужных функций
for _, v in pairs(getgc(true)) do
    if typeof(v) == "table" then
        if rawget(v, "trade") then
            for _, vv in pairs(v.trade) do
                if typeof(vv) == "function" then
                    trade_func = vv
                end
            end
        end
        if rawget(v, "_get_partner_offer") then
            partner_offer_func = v._get_partner_offer
        end
    end
end

-- Основные хуки
old.change = hookfunction(TradeApp._change_local_trade_state, function(self, changes)
    for k, v in pairs(changes) do
        if k == "sender_offer" or k == "recipient_offer" then
            for _, vv in pairs(v) do
                if vv == "items" then
                    local_offer = v.items
                end
            end
        end
    end
    return old.change(self, changes)
end)

old.overwrite = hookfunction(TradeApp._overwrite_local_trade_state, function(self, state)
    if local_offer and state then
        if game.Players.LocalPlayer == state.sender then
            state.sender_offer.items = local_offer
        else
            state.recipient_offer.items = local_offer
        end
    end
    return old.overwrite(self, state)
end)

-- Хук на партнёрский оффер (главное нововведение)
old.partner_offer = hookfunction(partner_offer_func, function(self, ...)
    local tbl, a = old.partner_offer(self, ...)
    if getgenv().fake_trade_active then
        tbl.player_name = getgenv().fake_partner_name
        tbl.items = getgenv().fake_partner_items
        tbl.confirmed = getgenv().fake_partner_confirmed
    end
    return tbl, a
end)

-- Сохранение локального оффера при подтверждении (для истории)
old.refresh = hookfunction(TradeApp.refresh_all, function(self, ...)
    local my = self:_get_my_offer()
    local partner = self:_get_partner_offer()
    if my.confirmed and partner.confirmed and local_offer then
        local trade_id = self.trade_state.trade_id or tostring(os.time())
        saved_ids[tostring(trade_id)] = {
            items = local_offer,
            name = getgenv().fake_partner_name
        }
    end
    return old.refresh(self, ...)
end)

-- История трейдов (чтобы в истории тоже показывало фейковый ник и петов)
old.history = hookfunction(create_trade_frame, function(...)
    local args = {...}
    local data = args[2]
    if data and saved_ids[tostring(data.trade_id)] then
        if data.sender_name == game.Players.LocalPlayer.Name then
            data.sender_items = saved_ids[tostring(data.trade_id)].items
            data.recipient_name = saved_ids[tostring(data.trade_id)].name
        else
            data.recipient_items = saved_ids[tostring(data.trade_id)].items
            data.sender_name = saved_ids[tostring(data.trade_id)].name
        end
    end
    return old.history(...)
end)

-- Фейковый профиль при клике на ник в трейде
old.profile = hookfunction(profile_func, function(_, id)
    if getgenv().fake_trade_active then
        return old.profile(_, game.Players.LocalPlayer.UserId) -- всегда свой профиль
    end
    return old.profile(_, id)
end)

-- Создание пета
local function createPet(name, fly, ride, neon, mega)
    local DB = require(game.ReplicatedStorage.ClientDB.Inventory.InventoryDB)
    for _, v in pairs(DB.pets) do
        if v.name:lower() == name:lower() then
            local unique = "2_"..tostring(math.random(1000000000000, 9999999999999))
            local inv = ClientData.get("inventory").pets
            inv[unique] = {
                unique = unique,
                category = "pets",
                id = v.id,
                kind = v.kind,
                properties = {
                    age = math.random(1,10),
                    rideable = ride,
                    flyable = fly,
                    neon = neon,
                    mega_neon = mega,
                    pet_trick_level = 0,
                    friendship_level = 0,
                    ailments_completed = 0
                }
            }
            if getgenv().fake_trade_active then
                table.insert(getgenv().fake_partner_items, inv[unique])
                if getgenv().current_tradeapp then
                    getgenv().current_tradeapp:refresh_all()
                end
            end
        end
    end
end

-- Интерфейс Rayfield
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({Name = "Постановка Adopt Me", LoadingTitle = "by твоя любимая блогерша <3"})

local Tab1 = Window:CreateTab("Фейк Трейд")
local Tab2 = Window:CreateTab("Создание петов")

-- === ТАБ 1 - ФЕЙК ТРЕЙД ===
Tab1:CreateLabel("Сначала выбери второй акк → Start Fake Trade → всё остальное")

local selected_player = nil

local Dropdown = Tab1:CreateDropdown({
    Name = "Выбери второй аккаунт",
    Options = (function()
        local t = {}
        for _, plr in pairs(game.Players:GetPlayers()) do
            if plr ~= game.Players.LocalPlayer then
                table.insert(t, plr.Name)
            end
        end
        return t
    end)(),
    CurrentOption = {"Выбери..."},
    Callback = function(opt)
        selected_player = game.Players[opt[1]]
    end,
})

game.Players.PlayerAdded:Connect(function() Dropdown:Refresh((function() local t={} for _,p in pairs(game.Players:GetPlayers()) do if p~=game.Players.LocalPlayer then table.insert(t,p.Name) end end return t end)()) end)
game.Players.PlayerRemoving:Connect(function() Dropdown:Refresh((function() local t={} for _,p in pairs(game.Players:GetPlayers()) do if p~=game.Players.LocalPlayer then table.insert(t,p.Name) end end return t end)()) end)

Tab1:CreateInput({
    Name = "Фейковый ник оппонента (JeffBlox, MeganPlays и т.д.)",
    PlaceholderText = "JeffBlox",
    CurrentValue = "JeffBlox",
    Callback = function(text)
        getgenv().fake_partner_name = text
    end,
})

Tab1:CreateButton({
    Name = "START FAKE TRADE",
    Callback = function()
        if not selected_player then
            Rayfield:Notify({Title="Ошибка", Content="Выбери второй аккаунт!", Duration=3})
            return
        end
        
        -- Отправляем настоящий трейд-запрос второму аккаунту
        RouterClient.get("TradeAPI/SendTradeRequest"):FireServer(selected_player.UserId)
        
        task.wait(1.5)
        
        -- Активируем фейк-режим
        getgenv().fake_trade_active = true
        getgenv().current_tradeapp = TradeApp
        getgenv().fake_partner_items = {}
        getgenv().fake_partner_confirmed = false
        
        Rayfield:Notify({Title="Успех", Content="Фейк-трейд запущен! Теперь добавляй петов оппоненту", Duration=5})
    end,
})

Tab1:CreateButton({
    Name = "Очистить оффер оппонента",
    Callback = function()
        if getgenv().fake_trade_active then
            getgenv().fake_partner_items = {}
            if getgenv().current_tradeapp then
                getgenv().current_tradeapp:refresh_all()
            end
        end
    end,
})

Tab1:CreateToggle({
    Name = "Оппонент подтвердил",
    CurrentValue = false,
    Callback = function(val)
        getgenv().fake_partner_confirmed = val
        if getgenv().current_tradeapp then
            getgenv().current_tradeapp:refresh_all()
        end
    end,
})

Tab1:CreateButton({
    Name = "Оппонент отказался / Закрыть трейд",
    Callback = function()
        getgenv().fake_trade_active = false
        getgenv().fake_partner_items = {}
        getgenv().fake_partner_confirmed = false
        if getgenv().current_tradeapp then
            getgenv().current_tradeapp:hide()
        end
    end,
})

-- === ТАБ 2 - СОЗДАНИЕ ПЕТОВ ===
local petname = "Shadow Dragon"
local ride, fly, neon, mega = false, false, false, false

Tab2:CreateInput({
    Name = "Название пета",
    PlaceholderText = "Shadow Dragon",
    CurrentValue = "Shadow Dragon",
    Callback = function(text) petname = text end,
})

Tab2:CreateToggle({Name = "Ride", Callback = function(v) ride = v end})
Tab2:CreateToggle({Name = "Fly", Callback = function(v) fly = v end})
Tab2:CreateToggle({Name = "Neon", Callback = function(v) neon = v end})
Tab2:CreateToggle({Name = "Mega Neon", Callback = function(v) mega = v end})

Tab2:CreateButton({
    Name = "Добавить в оффер ОППОНЕНТА",
    Callback = function()
        if not getgenv().fake_trade_active then
            Rayfield:Notify({Title="Ошибка", Content="Сначала запусти фейк-трейд!", Duration=3})
            return
        end
        createPet(petname, fly, ride, neon, mega)
    end,
})

Tab2:CreateButton({
    Name = "Добавить 10 случайных легендарок оппоненту",
    Callback = function()
        if not getgenv().fake_trade_active then return end
        local legends = {"Shadow Dragon","Giraffe","Frost Dragon","Bat Dragon","Owl","Parrot","Crow","Diamond Butterfly","Diamond Amazon"}
        for i = 1, 10 do
            local name = legends[math.random(#legends)]
            createPet(name, math.random()>0.5, math.random()>0.5, math.random()>0.7, math.random()>0.9)
        end
    end,
})

Rayfield:Notify({Title="Готово!", Content="Скрипт полностью загружен. Удачных постановок! <3", Duration=8})